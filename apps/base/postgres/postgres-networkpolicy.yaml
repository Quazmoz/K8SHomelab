---
# NetworkPolicy for PostgreSQL
# Restricts ingress to known database clients only
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-network-policy
  namespace: apps
  labels:
    app: postgres
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    # Allow PostgreSQL connections from known clients
    - from:
        # OpenWebUI - uses postgresql for backend
        - podSelector:
            matchLabels:
              app: openwebui
        # Phoenix - uses postgresql for observability data
        - podSelector:
            matchLabels:
              app: phoenix
        # FreshRSS - uses postgresql for RSS data
        - podSelector:
            matchLabels:
              app: freshrss
        # Authentik - uses postgresql for identity data
        - podSelector:
            matchLabels:
              app: authentik
        # pgAdmin - database administration tool
        - podSelector:
            matchLabels:
              app: pgadmin
        # MCPO - MCP proxy accessing postgres
        - podSelector:
            matchLabels:
              app: mcpo
        # Context Forge - MCP gateway with postgres backend
        - podSelector:
            matchLabels:
              app: context-forge
        # GroupMe Backend - uses postgres for token storage
        - podSelector:
            matchLabels:
              app: groupme-backend
        # Azure MCP Go - MCP server with postgres access
        - podSelector:
            matchLabels:
              app: azure-mcp-go
        # Postgres Exporter - metrics collection
        - podSelector:
            matchLabels:
              app: postgres-exporter
        # Grafana (for direct queries if needed)
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
        # n8n - workflow automation
        - podSelector:
            matchLabels:
              app: n8n
        # Coder - development workspaces
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: coder
        # AWX - uses postgres for ansible automation
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: awx
        # Postgres Backup CronJob
        - podSelector:
            matchLabels:
              app: postgres-backup
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 5432
