apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: loki
  namespace: default
spec:
  interval: 5m
  chart:
    spec:
      chart: loki
      version: "6.5.2"
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      interval: 1m
  values:
    # Explicitly select single-binary mode to satisfy chart validation
    mode: singleBinary

    # Ensure distributed/scalable targets are off
    write:
      enabled: false
    read:
      enabled: false
    backend:
      enabled: false

    # Inform chart helpers we use filesystem storage and avoid common storage block
    loki:
      storage:
        type: filesystem
      commonConfig: null

    singleBinary:
      enabled: true

      # Persistent volume for Loki data
      persistence:
        enabled: true
        storageClassName: "local-storage"
        size: 10Gi

      # Schedule on the node that has the local PV path
      nodeSelector:
        kubernetes.io/hostname: quinn-hpprobook430g6

      # Loki config for filesystem + boltdb-shipper
      config:
        auth_enabled: false
        server:
          http_listen_port: 3100
        storage_config:
          filesystem:
            directory: /data/loki
        schema_config:
          configs:
            - from: 2020-10-24
              store: boltdb-shipper
              object_store: filesystem
              schema: v11
              index:
                prefix: index_
                period: 24h