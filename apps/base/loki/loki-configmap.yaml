apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: apps
data:
  loki-config.yaml: |
    # This is the configuration for a simple, single-binary Loki instance.
    # ACCEPTED RISK: auth_enabled is false because this is a single-tenant homelab.
    # All access is internal (no external ingress). Documented per ยง9 compliance exception.
    auth_enabled: false

    server:
      http_listen_port: 3100

    # This tells Loki to run all components (ingester, querier, etc.) in one process.
    target: all

    # --- THIS IS THE CRITICAL FIX ---
    # This block configures the ring for a single-node setup, preventing
    # it from trying to contact a non-existent Consul instance.
    ingester:
      lifecycler:
        ring:
          kvstore:
            store: inmemory
          replication_factor: 1
      # This tells the ingester where to store its Write-Ahead Log (WAL).
      wal:
        enabled: true
        dir: /data/loki/wal

    storage_config:
      boltdb_shipper:
        active_index_directory: /data/loki/boltdb-shipper-active
        cache_location: /data/loki/boltdb-shipper-cache
        cache_ttl: 24h
      filesystem:
        directory: /data/loki/chunks
    
    compactor:
      working_directory: /data/loki/boltdb-shipper-compactor
      retention_enabled: true
      ring:
        kvstore:
          store: inmemory

    # ยง4b: Enforce 90-day log retention and limit query abuse
    limits_config:
      retention_period: 2160h  # 90 days (required by ยง4b)
      max_query_series: 5000   # Prevent resource abuse from excessive queries

    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    
    ruler:
      alertmanager_url: http://prometheus-alertmanager.apps.svc:9093

