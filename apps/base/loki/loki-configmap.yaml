apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
  namespace: apps
data:
  loki-config.yaml: |
    # This is the configuration for a simple, single-binary Loki instance.
    # ACCEPTED RISK: auth_enabled is false because this is a single-tenant homelab.
    # All access is internal (no external ingress). Documented per ยง9 compliance exception.
    auth_enabled: false

    server:
      http_listen_port: 3100

    # This tells Loki to run all components (ingester, querier, etc.) in one process.
    target: all

    common:
      path_prefix: /data/loki
      storage:
        filesystem:
          chunks_directory: /data/loki/chunks
          rules_directory: /data/loki/rules
      replication_factor: 1
      ring:
        kvstore:
          store: inmemory

    compactor:
      working_directory: /data/loki/boltdb-shipper-compactor
      retention_enabled: true
      delete_request_store: filesystem

    # ยง4b: Enforce 90-day log retention and limit query abuse
    limits_config:
      retention_period: 2160h  # 90 days (required by ยง4b)
      max_query_series: 5000   # Prevent resource abuse from excessive queries

    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h
    
    ruler:
      alertmanager_url: http://prometheus-alertmanager.apps.svc:9093

